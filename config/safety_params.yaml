# Safety Filter Parameters Configuration

# Safety filter type
filter:
  type: predictive    # 'predictive' (Wabersich), 'cbf', 'simple'
  enabled: true

# Backup controller
backup:
  type: lqr           # 'lqr', 'mpc', 'hover'
  
  # LQR settings
  lqr:
    Q_position: [100.0, 100.0, 100.0]
    Q_velocity: [10.0, 10.0, 10.0]
    Q_attitude: [50.0, 50.0, 50.0, 50.0]
    Q_angular_velocity: [10.0, 10.0, 10.0]
    R_thrust: [0.01, 0.01, 0.01]

# Tube computation
tube:
  method: ellipsoidal  # 'ellipsoidal', 'zonotope', 'polytope'
  
  # Horizon for backup trajectory
  horizon: 20
  dt: 0.1
  
  # Robust positive invariant set computation
  rpi:
    method: iterate     # 'iterate', 'lmi'
    max_iter: 100
    tolerance: 1.0e-6

# Terminal safe set
terminal_set:
  type: lmpc           # 'lmpc' (sampled), 'ellipsoid', 'polytope'
  
  # LMPC sampled safe set settings
  lmpc:
    k_neighbors: 10    # K nearest neighbors for local safe set
    use_convex_hull: true
    
    # Q-function interpolation
    q_interpolation: barycentric  # 'barycentric', 'nearest', 'rbf'
    
  # Ellipsoidal terminal set settings
  ellipsoid:
    use_lqr: true      # Compute from LQR Lyapunov function
    scale_factor: 0.8  # Scale to ensure constraint satisfaction
    
  # Fuel-aware shrinking
  fuel_aware: true
  fuel_margin: 50.0    # Minimum fuel reserve [kg]

# Constraint tightening
constraint_tightening:
  enabled: true
  method: probabilistic  # 'probabilistic', 'worst_case'
  
  # For probabilistic
  probability: 0.95
  
  # Safety margins
  margins:
    position: 1.0      # [m]
    velocity: 0.5      # [m/s]
    tilt: 5.0          # [deg]
    angular_velocity: 5.0  # [deg/s]

# Safety filter QP
qp:
  solver: osqp         # 'osqp', 'qpoases', 'cvxpy'
  
  # Objective: minimize ||u - u_learning||^2
  # Subject to: backup trajectory remains safe
  
  # Regularization
  input_regularization: 0.001
  
  # Solver settings
  max_iter: 100
  tolerance: 1.0e-5

# Intervention logging
logging:
  enabled: true
  log_interventions: true
  log_backup_trajectories: false
  log_path: data/logs/safety/

# Recovery behavior
recovery:
  # What to do after safety intervention
  after_intervention: continue  # 'continue', 'switch_to_backup', 'abort'
  
  # Consecutive intervention threshold
  max_consecutive: 10
  action_on_max: switch_to_backup
